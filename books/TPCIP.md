tcp/ip
tcp/ip

・回線交換方式(old)
1:1 回線固定(電話)データ少ない。
>>「パケット交換方式」へ！(now)
ヘッダーをつけて送る。

cf)ペイロード>>データ本体のこと。

cf)パケットは多義語
広義>>ネットワークを流れるデータそのもの
狭義>>ネットワーク層で処理されるPDU、IPパケットとも。

cf)カプセル化　>> 送信の時ヘッダをつけてく。
非カプセル化 >> ヘッダをとってく！



・プロトコル
パケットの流し方の決まり！
【定義されてるもの】
物理的な仕様、送信相手、ヘッダがどこまででどんな情報か、信頼性(再送方法など)、セキュリティ(暗号化・相手の確認方法など)

階層ごとにプロトコルは定義されてる。



・TCP/IP 参照モデルと OSI参照モデル
現在の主流は TCP/IP参照モデル。
OSI参照モデルは細かく定義しすぎて、実際のモデルとは少し離れてしまった。
間をとった5段階くらいが使いやすい
(アプリ、トランスポート、ネットワーク、データリンク、物理)



・PDU protocol data unit
各階層で処理されるデータの単位のこと。
ネットワーク層のPDU=IPパケット



・IEEE >> ハードウェアより
IEFT >> ソフトウェアより



・定番プロトコル
各層に使われるプロトコルはほぼ定番化してる。
物理層: 有線 = イーサネット(IEEE802.3)
無線 = IEEE802.11
ネットワーク層: IP
トランスポート層: TCP・UDP
アプリ層: HTTP, HTTPS, QUIC,DNS
実際の通信では、NICやOSなどがプロトコルを勝手に選んでくれるので、ユーザーは意識しない。
cf)NIC
パケットをネットワークに流す時必ず通る。
物理層近辺。
cf)アクセスポイント
電波<=> パケットのやりとりをする機器。
wifi や。


・データリンク層とMACアドレス
データリンク層はローカルの物理的なネットワーク(LAN)を取り扱うためのもの？(物理的につながった機器同士)
L2スイッチ(ルーター内に含まれてる？)がMACアドレステーブルを管理し、転送処理を管理してくれる。


・ネットワーク層
ルーターのルーティングテーブルによって転送処理が管理される。
cf)L3スイッチ = ルーター+L2スイッチ


・トランスポート層
ポート番号で転送先アプリを判別。
ファイアウォール(旧式)はここ。


・AS番号
Autonomous System
ISPがそれぞれもつ、ネットワーク上で一意の番号。これに基づいてネットワーク上をパケットが駆け巡る。



・DMZ
LAN の一種で、L3スイッチ>FW>L2スイッチ> LB > L2スイッチ、の外部からの侵入を守るLANjテンプレート構成みたいな感じ。


・SDN software defined network
要は仮想？
コントロールプレーン>>制御
データプレーン>>パケットをやりとり

オーバーレイ形 >> vpn的にトンネル化(VXLAN)
(最近はもっぱらオーバーレイ)
ホップバイホップ形>>openflow 使われてない


・CDN
DNSサーバーみたいな。
DNSを使うwebは全部これ使ってんのか？
エッジサーバー(キャッシュするサーバー)、オリジンサーバー(元のサーバー)


・IEEE802.3 イーサネット　p50.
有線はもう全部これって感じ。(イーサネットII)
基本現場では、〇〇BASE-▷▷ って呼ばれる。
ツイストペアケーブル(BASE-T)と光ファイバーケーブル(BASE-SX/SR, BASE-LX/LR)大別される。

cf)全二重と半二重
半二重はCSMA/CD で再送制御必要。もうあまり使われてない。
自動で今は決定してくれる。



・IEEE802.11
無線LAN,wifi >> p67
半二重しかない。CSMA/CA で衝突を回避しながら通信する。



・イーサネットフレーム
イーサネットでカプセル化したパケット。
cf)FCS frame check sum
最後の4バイト、イーサネットフレームのエラー検知の全て
cf)MACアドレス
上位3bit >> ベンダー固有のID(OUI)
下位3bit >> ベンダーが割り当てたID(UAA)


・フラッディング
L2スイッチは「MACアドレステーブル」を使用してLAN内で送信先を決める。
ただ最初は空っぽ。このときどうやってアドレスを決めるのか？
1. イーサネットフレーム送信元アドレス以外の端末全てにイーサネットフレームのコピーを送る
2. 宛先が一致した端末はイーサネットフレームに返信する。それ以外は破棄。
3. 返信により、MACアドレステーブルが更新



・VLANの原理
L2スイッチのポート毎に、「VLAN ID」を設定し、一致しない場所には送らないだけ。
1. ポートベースVLAN >>1ポート1VLAN(物理)
2. タグVLAN >> イーサネットフレームにつける


・無線LAN(IEEE802.11)がつながるまで
1. アソシエーション　スキャン(アクセスポイントのビーコンからの情報をゲットし、プローブ要求・返信)>>オープン認証>>アソシエーション要求・返信、が一連のアソシエーションの流れ。
2. 認証 マスターキーを生成する、生成方法は2つある。　①パーソナルモード(pw認証) ②エンタープライズ認証(認証サーバ利用、IEEE802.1x)
3. 共有鍵生成
4. 暗号化通信


・ARP Address Resolution Protocol
MACアドレスとIPアドレスの紐付けをするプロトコル。ARP フレームを送信して確かめる。
ARP Request(ブロードキャスト)
ARP Reply(ユニキャスト)
ARPテーブルにエントリ(=データ)としてキャッシュされる。

cf)GARP
IPアドレス設定の際に、重複確認しエラー検知するARP。
MACアドレスが変わった際、他端末のエントリを変更するためにも使用



・PPP 122p参照
ちなみにフレッツ光などもPPPoE(イーサネットカプセル化)で端末と網終端装置(NTE)が結ばれ、NTEが認証されるとNTEがISPのネット回線を使用できる。
ただ弱点もあり、さらに進化したIPoEが使用されてる。


・L2TP over IPsec
VPN でmac,windowsで標準的に使用されるプロトコル。p129参照



・IPフラグメンテーション
1500がIPパケットのデフォルトのMTU
これを超える情報量がトランスポートから来た場合、分割される。このとき分割されたipパケットには同じ識別子が付与され、それをもとに結合される。
ただ遅延の元になるので、最近は上位層で調整したりしている。



・NATとIPアドレス
IPアドレスは以下2つがあり、
その中でサブネットやクラスによって分類される。
プライベート、グローバルはNATによって変換される。
1. グローバルIPアドレス(一意)
2. プライベートIPアドレス


・IPv6
1. ヘッダー固定長 40バイト　長さチェックなくなり効率化
2. 無駄なフィールドは拡張ヘッダーへ　効率化
アドレスの読み方はむずいので、ちくいちp153参照
IPv6 は3つのアドレスクラスにわかれる。
1. ユニキャストアドレス　p158(ipv4よクラスA-C)
2. マルチキャストアドレス(ipv4のクラスD)
3. エニーキャストアドレス



・デフォルトゲートウェイ
ipルーティングにおいて、「ネクストホップ」と「宛先ネットワーク」を確認して、ipパケットをどこに飛ばすかを決定。
デフォルトルート(自分がわからないipアドレスを飛ばす先)によって飛ばされるネクストホップ=デフォルトゲートウェイ(家ならルーターになる)

・ipルーティング
ルーティングテーブル >> ARPテーブル(Macアドレスとipアドレス)>> MACアドレスを追加してカプセル化 >> 送信 >> ルーティングテーブル >> ARPテーブル >>送信
を繰り返す



・ルーティングプロトコル
動的ルーティングを管理するルールのこと。
IGPとEGPにわかれる。
AS(autonomous system)= 内部、lanみたいな感じ。
IGPはinteriorで、AS 内部を管理する。
EGPはASとASをつなぐルール管理。
・IGP
RIPはもう古く、だいたい、OSPFか、
EIGRP
・EGP
BGP一択らしい、
cf)メトリック
宛先ネットワークまでの距離のこと



・ルーティングの使用ルール
ロンゲストマッチ、ルート集約、AD値(優先度)




・NAT
広義と狭義がある。
静的NAT >> サーバーなどをネットに公開するよう。1:1対応
NAPT >> n:1。ポート番号ごとにIPアドレスを管理し、n:1のipアドレスとする。


・ICMPv4
IPを手助けするプロトコル。ping がこれ。
メッセージ最初の「タイプ」と「コード」によってIP層で何が起きてるか診断できる。



・TCPコネクション
TCPは事前に論理的に、受信パイプ、送信パイプをというトンネルを用意する=TCPコネクション。TCPヘッダーは以下の通り。
1. 送信元/宛先ポート番号　　　TCPがメインにやりとりするのはポート番号(アプリケーションを指定する)
2. シーケンス番号　　　アプリ層から受け取った番号に通し番号を振り、順番がバラバラになっても結合できるようにする。
3. ACK番号　　　シーケンス番号+1の番号が入る。次に欲しいデータのシーケンス番号はこれです！なイメージ。
4. データオフセット　　　ヘッダの長さがどこまで！を教えるデータ。
5. コントロールビット　　　TCPコネクションの状態を示す。
6. ウインドウサイズ　　　ACKなしで受け取れる量を示す。0がもう無理😥
7. チェックサム　　　いつもの。1の補数演算。
8. 緊急ポインタ　　　緊急データを示すやつらしい。まあまあ
9. オプション　　　拡張ヘッダ的な。MSSとSACKが重要。
※tcpセグメント=ペイロード+ヘッダ

・MSS Maximum Segment Size
　TCPペイロードの最大サイズ。ちなみにMTUはIPパケットの最大サイズ。デフォルトは大体1500-40(ipヘッダ+tcpヘッダ)=1460
・SACK Selectrve ACK
ACKだけだと送られていないところ以降のTCPセグメントを送信してしまう。(途切れたところ以降くださーい、がACK)
SACKはヘッダのオプションでどこ〜どこを受け取ったを保持するので、効率よい。
p248の図がわかりやすい。

・TCPのフェーズ
3にわかれる。
1. 接続開始　　　3WHS。3WHSの中で、「オープン」と呼ばれる準備を行う。SYN, SYN/ACK, ACK のパケットをやりとりする。(p251の図)
2. 接続確立　　　フロー制御・輻輳制御・再送制御の3つを使用し、コネクションの品質維持を行う。
3. 接続終了フェーズ　　　4WHS。「クローズ」と呼ばれる処理。FIN, ACK, FIN/ACK, FIN/ACKで終了。
closed, listen, open などのソケット状態はこれか！

・フロー制御
MSSに反しないまで送る。それ以降はACKを待ち、溢れないようにする。(スライディングウインドウ、p252の図)
・輻輳制御
混雑を制御。難しい😥
・再送制御
ACKパケットでパケットロスを認識した場合に使う。パケットロスすると受け取ったよ、というACKは何度も同じシーケンス番号という内容になる(=重複ACK)
一定回数以上の重複ACKで、パケット再送をする。
※再送タイムアウト
ACKが一定時間来ない場合でも、タイマーにてパケットを送り直す。ネットが重いのは大体これ。






