tcp/ip

・回線交換方式(old)
1:1 回線固定(電話)データ少ない。
>>「パケット交換方式」へ！(now)
ヘッダーをつけて送る。

cf)ペイロード>>データ本体のこと。

cf)パケットは多義語
広義>>ネットワークを流れるデータそのもの
狭義>>ネットワーク層で処理されるPDU、IPパケットとも。

cf)カプセル化　>>  送信の時ヘッダをつけてく。
非カプセル化 >>  ヘッダをとってく！



・プロトコル
パケットの流し方の決まり！
【定義されてるもの】
物理的な仕様、送信相手、ヘッダがどこまででどんな情報か、信頼性(再送方法など)、セキュリティ(暗号化・相手の確認方法など)

階層ごとにプロトコルは定義されてる。



・TCP/IP 参照モデルと OSI参照モデル
現在の主流は TCP/IP参照モデル。
OSI参照モデルは細かく定義しすぎて、実際のモデルとは少し離れてしまった。
間をとった5段階くらいが使いやすい
(アプリ、トランスポート、ネットワーク、データリンク、物理)



・PDU protocol data unit
各階層で処理されるデータの単位のこと。
ネットワーク層のPDU=IPパケット



・IEEE >> ハードウェアより
IEFT >> ソフトウェアより



・定番プロトコル
各層に使われるプロトコルはほぼ定番化してる。
物理層: 有線 = イーサネット(IEEE802.3)
無線 = IEEE802.11
ネットワーク層: IP
トランスポート層: TCP・UDP
アプリ層: HTTP, HTTPS, QUIC,DNS
実際の通信では、NICやOSなどがプロトコルを勝手に選んでくれるので、ユーザーは意識しない。
cf)NIC 
パケットをネットワークに流す時必ず通る。
物理層近辺。
cf)アクセスポイント
電波<=> パケットのやりとりをする機器。
wifi や。


・データリンク層とMACアドレス
データリンク層はローカルの物理的なネットワーク(LAN)を取り扱うためのもの？(物理的につながった機器同士)
L2スイッチ(ルーター内に含まれてる？)がMACアドレステーブルを管理し、転送処理を管理してくれる。


・ネットワーク層
ルーターのルーティングテーブルによって転送処理が管理される。
cf)L3スイッチ = ルーター+L2スイッチ


・トランスポート層
ポート番号で転送先アプリを判別。
ファイアウォール(旧式)はここ。


・AS番号
Autonomous System
ISPがそれぞれもつ、ネットワーク上で一意の番号。これに基づいてネットワーク上をパケットが駆け巡る。



・DMZ
LAN の一種で、L3スイッチ>FW>L2スイッチ> LB > L2スイッチ、の外部からの侵入を守るLANjテンプレート構成みたいな感じ。


・SDN software defined network
要は仮想？
コントロールプレーン>>制御
データプレーン>>パケットをやりとり

オーバーレイ形 >> vpn的にトンネル化(VXLAN)
(最近はもっぱらオーバーレイ)
ホップバイホップ形>>openflow 使われてない


・CDN
DNSサーバーみたいな。
DNSを使うwebは全部これ使ってんのか？
エッジサーバー(キャッシュするサーバー)、オリジンサーバー(元のサーバー)


・IEEE802.3 イーサネット　p50.
有線はもう全部これって感じ。(イーサネットII)
基本現場では、〇〇BASE-▷▷ って呼ばれる。
ツイストペアケーブル(BASE-T)と光ファイバーケーブル(BASE-SX/SR, BASE-LX/LR)大別される。

 cf)全二重と半二重
半二重はCSMA/CD で再送制御必要。もうあまり使われてない。
自動で今は決定してくれる。



・IEEE802.11
  無線LAN,wifi  >> p67
半二重しかない。CSMA/CA で衝突を回避しながら通信する。



・イーサネットフレーム
イーサネットでカプセル化したパケット。
cf)FCS frame check sum
最後の4バイト、イーサネットフレームのエラー検知の全て
cf)MACアドレス
上位3bit >> ベンダー固有のID(OUI)
下位3bit >> ベンダーが割り当てたID(UAA)


・フラッディング
L2スイッチは「MACアドレステーブル」を使用してLAN内で送信先を決める。
ただ最初は空っぽ。このときどうやってアドレスを決めるのか？
イーサネットフレーム送信元アドレス以外の端末全てにイーサネットフレームのコピーを送る
宛先が一致した端末はイーサネットフレームに返信する。それ以外は破棄。
返信により、MACアドレステーブルが更新



・VLANの原理
L2スイッチのポート毎に、「VLAN ID」を設定し、一致しない場所には送らないだけ。
ポートベースVLAN  >>1ポート1VLAN(物理)
タグVLAN >> イーサネットフレームにつける


・無線LAN(IEEE802.11)がつながるまで
アソシエーション　スキャン(アクセスポイントのビーコンからの情報をゲットし、プローブ要求・返信)>>オープン認証>>アソシエーション要求・返信、が一連のアソシエーションの流れ。
認証   マスターキーを生成する、生成方法は2つある。　①パーソナルモード(pw認証) ②エンタープライズ認証(認証サーバ利用、IEEE802.1x)
共有鍵生成
暗号化通信


・ARP  Address Resolution Protocol
MACアドレスとIPアドレスの紐付けをするプロトコル。ARP フレームを送信して確かめる。
ARP Request(ブロードキャスト)
ARP Reply(ユニキャスト)
ARPテーブルにエントリ(=データ)としてキャッシュされる。

cf)GARP
IPアドレス設定の際に、重複確認しエラー検知するARP。
MACアドレスが変わった際、他端末のエントリを変更するためにも使用



・PPP 122p参照
ちなみにフレッツ光などもPPPoE(イーサネットカプセル化)で端末と網終端装置(NTE)が結ばれ、NTEが認証されるとNTEがISPのネット回線を使用できる。
ただ弱点もあり、さらに進化したIPoEが使用されてる。


・L2TP over IPsec
VPN でmac,windowsで標準的に使用されるプロトコル。p129参照



・IPフラグメンテーション
1500がIPパケットのデフォルトのMTU
これを超える情報量がトランスポートから来た場合、分割される。このとき分割されたipパケットには同じ識別子が付与され、それをもとに結合される。
ただ遅延の元になるので、最近は上位層で調整したりしている。



・NATとIPアドレス
IPアドレスは以下2つがあり、
その中でサブネットやクラスによって分類される。
プライベート、グローバルはNATによって変換される。
グローバルIPアドレス(一意)
プライベートIPアドレス


・IPv6
ヘッダー固定長 40バイト　長さチェックなくなり効率化
無駄なフィールドは拡張ヘッダーへ　効率化
アドレスの読み方はむずいので、ちくいちp153参照
IPv6 は3つのアドレスクラスにわかれる。
ユニキャストアドレス　p158(ipv4よクラスA-C)
マルチキャストアドレス(ipv4のクラスD)
エニーキャストアドレス



・デフォルトゲートウェイ
ipルーティングにおいて、「ネクストホップ」と「宛先ネットワーク」を確認して、ipパケットをどこに飛ばすかを決定。
デフォルトルート(自分がわからないipアドレスを飛ばす先)によって飛ばされるネクストホップ=デフォルトゲートウェイ(家ならルーターになる)

・ipルーティング
ルーティングテーブル >> ARPテーブル(Macアドレスとipアドレス)>> MACアドレスを追加してカプセル化 >> 送信 >> ルーティングテーブル >> ARPテーブル >>送信
を繰り返す



・ルーティングプロトコル
動的ルーティングを管理するルールのこと。
IGPとEGPにわかれる。
AS(autonomous system)= 内部、lanみたいな感じ。
IGPはinteriorで、AS 内部を管理する。
EGPはASとASをつなぐルール管理。
・IGP
RIPはもう古く、だいたい、OSPFか、
EIGRP
・EGP
BGP一択らしい、
cf)メトリック
宛先ネットワークまでの距離のこと



・ルーティングの使用ルール
ロンゲストマッチ、ルート集約、AD値(優先度)




・NAT
広義と狭義がある。
静的NAT >> サーバーなどをネットに公開するよう。1:1対応
NAPT >> n:1。ポート番号ごとにIPアドレスを管理し、n:1のipアドレスとする。


・ICMPv4
IPを手助けするプロトコル。ping がこれ。
メッセージ最初の「タイプ」と「コード」によってIP層で何が起きてるか診断できる。



・TCPコネクション
TCPは事前に論理的に、受信パイプ、送信パイプをというトンネルを用意する=TCPコネクション。TCPヘッダーは以下の通り。
送信元/宛先ポート番号　　　TCPがメインにやりとりするのはポート番号(アプリケーションを指定する)
シーケンス番号　　　アプリ層から受け取った番号に通し番号を振り、順番がバラバラになっても結合できるようにする。
ACK番号　　　シーケンス番号+1の番号が入る。次に欲しいデータのシーケンス番号はこれです！なイメージ。
データオフセット　　　ヘッダの長さがどこまで！を教えるデータ。
コントロールビット　　　TCPコネクションの状態を示す。
ウインドウサイズ　　　ACKなしで受け取れる量を示す。0がもう無理😥
チェックサム　　　いつもの。1の補数演算。
緊急ポインタ　　　緊急データを示すやつらしい。まあまあ
オプション　　　拡張ヘッダ的な。MSSとSACKが重要。
※tcpセグメント=ペイロード+ヘッダ

・MSS Maximum Segment Size
　TCPペイロードの最大サイズ。ちなみにMTUはIPパケットの最大サイズ。デフォルトは大体1500-40(ipヘッダ+tcpヘッダ)=1460
・SACK Selectrve ACK
ACKだけだと送られていないところ以降のTCPセグメントを送信してしまう。(途切れたところ以降くださーい、がACK)
SACKはヘッダのオプションでどこ〜どこを受け取ったを保持するので、効率よい。
p248の図がわかりやすい。

・TCPのフェーズ
3にわかれる。
接続開始　　　3WHS。3WHSの中で、「オープン」と呼ばれる準備を行う。SYN, SYN/ACK, ACK のパケットをやりとりする。(p251の図)
接続確立　　　フロー制御・輻輳制御・再送制御の3つを使用し、コネクションの品質維持を行う。
接続終了フェーズ　　　4WHS。「クローズ」と呼ばれる処理。FIN, ACK, FIN/ACK, FIN/ACKで終了。
closed, listen, open などのソケット状態はこれか！

・フロー制御
MSSに反しないまで送る。それ以降はACKを待ち、溢れないようにする。(スライディングウインドウ、p252の図)
・輻輳制御
混雑を制御。難しい😥
送信端末ウィンドウ ← min(輻輳ウィンドウ，フロー制御ウィンドウ)
なる❗️輻輳でもウインドウサイズを変化させるのね🔥🔥
https://www.ieice-hbkb.org/files/03/03gun_04hen_01.pdf
・再送制御
ACKパケットでパケットロスを認識した場合に使う。パケットロスすると受け取ったよ、というACKは何度も同じシーケンス番号という内容になる(=重複ACK)
一定回数以上の重複ACKで、パケット再送をする。
※再送タイムアウト
ACKが一定時間来ない場合でも、タイマーにてパケットを送り直す。ネットが重いのは大体これ。

・TCPファストオープン
2回目以降のオープンでの3whs にて、3whsのパケットにもアプリのデータをのせちゃう🚗

・Nagle アルゴリズム <-> 遅延ACK
送信データをまとめる vs ACKをまとめる




【アプリケーション層】
⭐️HTTP
・キープアライブ
TCPコネクションを繋ぎっぱなしにしておく。昔はなかったから、リクエスト毎に繋ぎ直してた。
・マルチブレキシング(HTTP/2)
一つのTCPコネクション内に、複数の「ストリーム」を形成して並列処理を可能にするもの。(パイプラインの失敗をうけて)
・HPACK(HTTP/2)
よく使うヘッダをテンプレとして圧縮し、データを削減。
・サーバープッシュ(HTTP/2)
次のリクエストを予想して、先送りしキャッシュさせ、表示を早くする(htmlの次はcss,jsみたいな)

・リクエスト、レスポンスヘッダー
Accept* -> クライアントのブラウザが処理できる内容と優先度を教えるヘッダ、acceptはすべてそれ。
cf)一般ヘッダー
リクエスト・レスポンスに共通するヘッダー
cf)エンティティヘッダー
リクエスト・レスポンスに共通するヘッダーかつ、メッセージボディに対しての指示をするヘッダー


・ETagヘッダ(レスポンス) 
webページをサーバが一意に判断するID
日付などから算出されるので、webページの更新を判別できる。

・Cache-Controlヘッダ
キャッシュ方法などに対して「ディレクティブ」なる命令文にて指示を加えることができる

・Content-Length ヘッダー
メッセージの長さ(終わり)を伝える。
キープアライブがあるから、どこでメッセージがおわるか伝えないと無駄になる、、❓
あれ？ 4whsは❓❓
あーいや、4whsはアプリ層から連絡がきてはじめて切断するのか😉


・Cookie
Set-Cookie ヘッダで、サーバーがクライアントのwebブラウザに対して、セッションIDを格納して送信。
webブラウザにFQDN毎に保存され、以降CookieヘッダにセッションIDは付与される🍪


・X-forwarded-forヘッダ
ロードバランサなどで元のipアドレスを格納しておく
cf)X-forwarded-proto
ロードバランサまでで使用されていたプロトコルを格納、sslオフロード(sslアクセラレーション)とかで使われる🛁

・HTTP/2のバイナリ処理
バイナリでやりとりし、HEADフレーム、DATAフレームにわけ、それぞれストリームIDを付与する。p304をみろ。

・宛先NAT🔩
ロードバランサーがNAT管理する
コネクションテーブルを用いるこれも😉
cf)ヘルスチェック
p314を参照。


・ADC application delivery controler
アプリケーション層まで幅を広げたロードバランサー
cf)パーシステンス
アプリは処理を同じサーバーで継続する必要があるものも多く(ECサイトとか)、同じサーバーへ割り振るための設定
cookie🍪ver と ipアドレス📮ver がある。


・MAC Message Authetication Code
メッセージのハッシュ化を行う際に、共通鍵も入れ込んでハッシュ化する、SSLで使われる方法。
改竄検知だけでなく、相手の認証もできる。

・デジタル署名の仕組み
「署名前証明書(サーバーinfo + サーバーinfo用ハッシュアルゴリズム)」を認証局の秘密鍵で暗号化する。



